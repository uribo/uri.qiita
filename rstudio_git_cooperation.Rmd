---
title: "RStudioではじめるGitによるバージョン管理: GitHubを使ったソーシャルコーディング"
author: "Shinya Uryu"
date: "2015年6月7日"
output: 
  md_document:
    variant: markdown_github
---

```{r, include = FALSE, cache = FALSE}
opts_chunk$set(eval = FALSE)
```

先日、Tokyo.RでRStudioとGitの話をしてきましたが、尻切れトンボな感じで中途半端に終わってしまったので改めてまとめておきます。Gitにはさまざまな機能がありますが、ここではRStudio上でできる基本的な操作にのみ焦点を絞ります（背景... Gitの操作はターミナルでやるのが常だが、ゆとりなのでGUIを使いたい ref) [gitって別にGUIから使ってもいいじゃん - 半空洞男女関係](http://mactkg.hateblo.jp/entry/2015/03/08/012827)）。Git, GitHubとの連携を行う準備編と、基本操作を述べる作業編、そしてこういう状況ではどう対応するかという応用編の３つに分けて説明します。

なお、すでに使用しているパソコンでGitのインストールやsshキーの発行およびGitHubのアカウント作成等が済んでいるものとして話を進めます。Gitの設定などは末尾に挙げる参考文献や[IT苦手な人のためのWindows+gitでRStudioによるバージョン管理入門 - Analyze IT.](http://d.hatena.ne.jp/EulerDijkstra/20130327/1364392046/) が参考になります。

# 準備編

## 1. ローカルリポジトリ（Rproject）を作成する

ここはいつもどおり。メニューバーのFile -> New Project... からRprojectフォルダを作成（または既存ファイルと紐付け）します。Rパッケージ用でも同様です。

この際、**gitリポジトリを作成するか、というオプション項目があるのでチェック**してgitリポジトリ（.gitフォルダ... 不可視フォルダなので通常は見えない）を作成します。なお後から作成しても問題ありません（既存フォルダをGit管理する場合はこの状態）。

![__git_uri_qiita_-_master_-_RStudio.png](https://qiita-image-store.s3.amazonaws.com/0/19462/6d515e3d-2041-c54d-ee21-86e4edd6c3ee.png)

さて、新規Rprojectを立ち上げると次のような画面になっています。Gitリポジトリを作成するように指定しましたので、左上にGit用のパネルがあり、いくつかのファイル名が挙げられています。Gitパネルは３つの列からなる構造をしており、各列は`Staged`、`Status`、`Path`となっています。**RStudioではここのパネルを使ってGitの操作を行います**。

![スクリーンショット_2015-09-06_12_06_06.png](https://qiita-image-store.s3.amazonaws.com/0/19462/d77bfed9-41df-8153-38c4-b8065a2729c7.png)

もしもGitパネルが見つからない場合、メニューのPreferencesから、Pane LayoutにいてVCS(Version Control System)を有効にしてください。

## 2. GitHub上にリモートリポジトリを設定する

ローカル上にGitリポジトリを作成したので、続いてリモートリポジトリをGitHub上に設置します。GitHubでは基本的に作成するリポジトリはすべて公開されますので、非公開にしたいGitリポジトリについては、有料サービスのプライベートリポジトリを利用するか、別のシステムを使ってください。

https://github.com/new にアクセスし、適当なリポジトリ名を打ちます（ローカルに作成したRprojectと対応していたほうが都合が良い）。リポジトリ作成のボタンを押すとローカルリポジトリ上にリモートリポジトリを追加する方法を説明するページに飛ぶので、「`git remote add origin https://github.com/<ユーザー名>/<作成したリポジトリ名>.git` 」の部分をコピーしてRStudioに戻ります。

RStudioのGitパネルにあります、歯車ボタンを押すと、`Shell...`という項目があります。それを押すとMacではターミナルが立ち上がるので、そちらに先程コピーした`git remote add ~`を貼り付けまたは打ち込んでリモートリポジトリを紐付けます。これでGitHubのリポジトリをリモートリポジトリとして設定する用意が完了しました。

RStudioに戻ると、新たにGitパネル上に`master`という項目が追加されています。これは現在のブランチを示しており、`master`がローカルリポジトリ、`origin/master`というのがGitHubに作成したリモートリポジトリを指しています。ブランチについては後述します。ではいよいよファイルをGitで管理してみましょう。

# 作業編

新規でRprojectを作成した段階だと、Gitパネルには`.gitignore`と`<Rproject名>.Rproj`という２つのファイルがあります。ファイル名の横にはチェックボックスと黄色のアイコンがあります。Gitパネルでは、このように３つの列で各ファイルおよびフォルダのGit管理状態を表示します。

黄色のアイコンが２つ並んでいる列はStatus列で、現在はどちらも「？」となっています。これはまだGit管理されていないことを意味しており、Gitがバージョンを管理するのかどうか迷っている段階になります。どちらもGitで管理したいファイルなのでStaged列のチェックボックスにチェックをつけましょう。するとStatusが「A」になりました。これは「新たに追加された（Added）」を意味します。新しくバージョン管理を行うファイルでは、すべてこのような段取りをとります。

Staged列にチェックを付けたら現在のファイル状態を記録するよう、コミットしましょう。GitパネルにCommitというボタンがあるので、それを押すと、新たに画面が立ち上がりますので、そちらのCommit messageという箇所にコミット文を書きます。

![OUemYxNo1S.gif](https://qiita-image-store.s3.amazonaws.com/0/19462/64f70c7e-7eb2-0b3b-64a2-0669e54f7e54.gif)

**管理するファイルを指定して、コミットする**。これが基本的な流れになります。今回はGit管理の対象にするという操作でしたが、以降で説明する変更点を反映させたりするのも同様の操作となります。

## ローカル上にあるファイルの変更を反映させる

ファイルをGit管理の対象に加えた後は、各ファイルの変更点を確認しながらファイルを編集することが可能です。先程コミットした`.gitignote`を対象に、今度は変更点をコミットしましょう。`.gitignote`の役割についても同時に説明します。

### Git管理しないファイル、拡張子は.gitignoreに追加する

`.gitignote`という不可視ファイルはGitバージョン管理において特別な役割を持っています。それは、バージョン管理を行わない（無視する ignore）ファイルを指定するためのファイルです。新規作成したRproject内の`.gitignote`はつぎのファイルが明記されています。いずれも不可視ファイルであり、特にバージョン管理する必要のないファイルです。

```
.Rproj.user
.Rhistory
.RData
```

Gitによるバージョン管理では、管理対象になるのは基本的にテキストファイルなので、マルチバイトのファイルなどはこうして`.gitignote`に追加しておくことをおすすめします。不必要なファイルを管理対象にしないことで、リポジトリが綺麗に保たれます。

例えば、RMarkdownで作成したファイルをknitして生成されるhtmlファイルはテキストファイルですが、.Rmdのファイルがあればそれをもとにして生成することが可能なのでバージョン管理の対象から外すようにします。個別のファイル名でも指定可能ですが、今回は.html拡張子のファイル全てを対象にしたいので、`*.html`を`.gitignore`に追加しておきます。すると、ローカルには生成したHTMLファイルが残っていますが、Gitパネル上からはHTMLファイルが消えています。きちんと管理の対象外にする指定ができています。

さて本題に戻りましょう。変更点をコミットする、という話です。今、`.gitignote`に`*.html`を追加したため、Gitパネルでは`.gitignote`の状態が青色の「M」になりました。Git管理の対象にあるファイルに変更が加えられるとこのように**M**odifiedを示すようになります。この状態でDiffボタンを押すと、前回のコミットからの変更点を確認することが可能です。緑色でハイライトされた部分が新たに追加された部分を示しており、きちんと`*.html`が追加されたことがわかります。

![cmAFhfiPtR.gif](https://qiita-image-store.s3.amazonaws.com/0/19462/5a7117e2-e0f3-8740-0f75-d9af80b744e6.gif)

htmlファイルをバージョン管理の対象から外したことをコミットしておきましょう。Staged列にチェックをつけてコミットメッセージを書いてコミットします。

## 差分の表示

一度コミットしたファイルでは、Gitに記録されている状態とローカルリポジトリにあるファイルの差分を見ることができます。Gitパネルでファイルを選択し、Diffアイコンを押すと、新たに次のような画面が立ち上がります。

![スクリーンショット 2015-09-06 11.15.23.png](https://qiita-image-store.s3.amazonaws.com/0/19462/f8f75512-3063-cfb6-fbac-c1dfe86b4787.png)

ここで緑色でハイライトされる部分が変更および新たに追加した箇所を示しており、赤色でハイライトされている部分が削除された部分となります。

## pushとpull

### push: リモートリポジトリに変更点を反映させる

いくつかのコミットがたまり、問題がないことを確認したら頃合いを見計らってGitHub上にあるリモートリポジトリに変更点を反映しましょう。リモートリポジトリにローカルリモートリポジトリの変更履歴を反映させることを`push`といいます。RStudioのGitパネルにある↑ボタンが`git push`と同じ働きをします。このボタンを押すと、登録されているGitHubリモートリポジトリとローカルリポジトリが同期されます。

### pull: リモートリポジトリからの変更を取り入れる

今度はリモートリポジトリからの変更をローカルリモートリポジトリに反映させてみます。これは、リモートリポジトリを使うことの利点でもあり、GitHubによる共有リポジトリの特徴でもあります。プルリクエストを取り込み、masterブランチにマージしたときなどにこの操作を行います（GitHubのリモートリポジトリでマージした状態をローカルリポジトリにも適用させる）。

先程の矢印とは逆向きの↓が`pull`を示します。

## コミット履歴を見る

RStudioのGitパネルにある時計のアイコンをクリックすると、これまでのコミットおよびマージした記録が表示されます。ブランチや特定のファイル・ディレクトリを対象にした履歴の表示が可能です。また、コミットコメントをもとにした検索も可能です。

## ステータスを理解する

`Status`列のアイコンと色は次の状態を示しています。

| アイコン     | 色  | 状態                                   |
|--------------|-----|:---------------------------------------|
| **?** ![git-unknown.png](https://qiita-image-store.s3.amazonaws.com/0/19462/6701f0b2-8008-08b5-fd1b-4f52e9cf8092.png) | 黄  | untracked git管理の対象になっていない  |
| **M**odified ![git-modified.png](https://qiita-image-store.s3.amazonaws.com/0/19462/003a537c-a381-b341-5657-eec3fe5039ab.png) | 青  | リポジトリの状態から変更された         |
| **D**elete ![git-deleted.png](https://qiita-image-store.s3.amazonaws.com/0/19462/95e26e47-1f6e-f383-9a23-781feb9124d9.png)  | 赤  | リポジトリにあったファイルが削除された |
| **A**dded ![git-added.png](https://qiita-image-store.s3.amazonaws.com/0/19462/45aed923-c813-657f-b9c9-c9a5f919ffde.png)   | 緑  | 新たにgit管理状態になった              |
|       ![git-commit-conflict.png](https://qiita-image-store.s3.amazonaws.com/0/19462/18f55d6e-704a-803b-4e96-776a00a13da0.png)    | 橙  | リポジトリ間で差分が衝突している       |

## ステージングについて

わかりやすいので参考にしてください。

[gitのステージングって何？必要なの？ - Qiita](http://qiita.com/YumaInaura/items/9ea051feb8140dfe0272)

# 応用編

## 既存のRprojectをGitでバージョン管理する

すでに存在するRprojectに対し、バージョン管理を開始するには、メニューバーのTools -> Project Options... -> Git/SVNでVersion Control SystemをnoneからGitに変更するだけです。更にGitHubと連携する場合にも、上記のとおりShellでリモートリポジトリを追加すれば良いです。

## ショートカットキーの活用

* 差分の表示 `control + option + D`... すでにコミットされている状態のファイルと現在編集中のファイルの差分を表示
* コミット `control + option + M`... コミット画面の起動

## コミットの操作

### 以前のコミット状態を復元する

Git管理しているファイルでは、現在編集したファイルをすでにコミットしている状態に戻すことが容易です。いろいろ書いたけど、やっぱりこれはダメだ、という場合にはこうした復元が役立ちます。RStudioのGitパネルに表示されているファイル名を右クリックすると、Revert... という文字列が表示されるので、それをクリックすると、確認のための画面が立ち上がります。確認のボタンを押すとファイルが以前のコミット状態に戻ります。

### 直前のコミットを取り消す

pushしていない直前のコミットであれば、コミットを取り消すことができます。commitアイコンを押し、Amend previous commitにチェックをつけると、直前のコミットは打ち消され、再度コミットを行うようになります。ファイルに取りこぼしや付け加えるファイルがあった場合に役立ちます。

### ファイル内の一部分だけコミット

ファイル全体ではなく、ファイル内の変更点の一部のみをコミットすることも可能です。対象ファイルをstageに上げた状態でDiff画面を立ち上げ、コミットに含めない部分を行単位で選択します。するとUnstaged selectionというボタンが表示されるので、それを押します。するとその部分は今回のコミットからは外されます。コードには残ったままなので、とりあえずここだけ変更しておく、というときに有効です。逆に、ここだけ追加するというときにはStageにのせる前の状態で、箇所を選択し、Stage selectionを押します。

### RからGitを操作するパッケージ

`{git2r}`パッケージの使い方については以前に少しだけ[書いた](http://rpubs.com/uri-sy/demo_git2r)が情報が古いし、扱っている量そのものがわずかしかない。

Enjoy!

# 参考文献

RStudioおよびGit連携機能について書かれている本は少ないが、次にあげる書籍では取り扱われている。

* 石田基広 Rで学ぶデータ・プログラミング入門: R Studioを活用する (2012). 共立出版
* 石田基広 改訂2版 R言語逆引きハンドブック (2014). C&R研究所
* 荒引健ほか R言語上級ハンドブック (2013). C&R研究所
* Jared P. Lander. R for Everyone: Advanced Analytics and Graphics (2013). Addison-Wesley Professional
    * Jared P. Lander. 高柳慎一ら訳 みんなのR -データ分析と統計解析の新しい教科書 (2015). マイナビ
* Hadley Wickham. R Packages (2015). O'Reilly... Chapter 12を読むと良い。
